name: Modality Agent Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'IntelIntent_Seeding/ModalityDataHelper.psm1'
      - 'Tests/ModalityDataHelper.Tests.ps1'
      - '.github/workflows/modality-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'IntelIntent_Seeding/ModalityDataHelper.psm1'
      - 'Tests/ModalityDataHelper.Tests.ps1'
  workflow_dispatch:

jobs:
  test:
    name: Run Modality Agent Tests
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup PowerShell 7
      uses: actions/setup-powershell@v1
      
    - name: Install Pester 5.5.0+
      shell: pwsh
      run: |
        Install-Module -Name Pester -MinimumVersion 5.5.0 -Force -SkipPublisherCheck
        Import-Module Pester -MinimumVersion 5.0 -PassThru
        
    - name: Run Pester Tests
      shell: pwsh
      run: |
        $config = New-PesterConfiguration
        $config.Run.Path = './Tests/ModalityDataHelper.Tests.ps1'
        $config.Output.Verbosity = 'Detailed'
        $config.Run.PassThru = $true
        $config.CodeCoverage.Enabled = $true
        $config.CodeCoverage.Path = './IntelIntent_Seeding/ModalityDataHelper.psm1'
        $config.CodeCoverage.OutputFormat = 'JaCoCo'
        $config.CodeCoverage.OutputPath = './coverage.xml'
        $config.TestResult.Enabled = $true
        $config.TestResult.OutputFormat = 'NUnitXml'
        $config.TestResult.OutputPath = './test-results.xml'
        
        $result = Invoke-Pester -Configuration $config
        
        # Output summary
        Write-Host "`n=== Test Summary ===" -ForegroundColor Cyan
        Write-Host "Total Tests: $($result.TotalCount)" -ForegroundColor White
        Write-Host "Passed: $($result.PassedCount)" -ForegroundColor Green
        Write-Host "Failed: $($result.FailedCount)" -ForegroundColor $(if ($result.FailedCount -gt 0) { 'Red' } else { 'Green' })
        Write-Host "Skipped: $($result.SkippedCount)" -ForegroundColor Yellow
        Write-Host "Duration: $($result.Duration.TotalSeconds) seconds" -ForegroundColor White
        
        # Exit with failure if tests failed
        if ($result.FailedCount -gt 0) {
            exit 1
        }
    
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: test-results.xml
    
    - name: Upload Code Coverage
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-coverage
        path: coverage.xml
    
    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action/composite@v2
      if: always()
      with:
        files: |
          test-results.xml
    
    - name: Add Test Summary to GitHub Step Summary
      if: always()
      shell: pwsh
      run: |
        $testResults = [xml](Get-Content ./test-results.xml)
        $total = $testResults.'test-results'.'total'
        $passed = $testResults.'test-results'.'passed'
        $failed = $testResults.'test-results'.'failures'
        $skipped = $testResults.'test-results'.'not-run'
        
        $summary = @"
        ## üß™ Modality Agent Test Results
        
        | Metric | Value |
        |--------|-------|
        | **Total Tests** | $total |
        | **Passed** | ‚úÖ $passed |
        | **Failed** | $(if ($failed -gt 0) { '‚ùå' } else { '‚úÖ' }) $failed |
        | **Skipped** | ‚è≠Ô∏è $skipped |
        | **Pass Rate** | $([math]::Round(($passed / $total) * 100, 2))% |
        "@
        
        Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summary
  
  lint:
    name: PowerShell Script Analysis
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup PowerShell 7
      uses: actions/setup-powershell@v1
      
    - name: Install PSScriptAnalyzer
      shell: pwsh
      run: |
        Install-Module -Name PSScriptAnalyzer -Force -SkipPublisherCheck
        
    - name: Run PSScriptAnalyzer
      shell: pwsh
      run: |
        $results = Invoke-ScriptAnalyzer -Path './IntelIntent_Seeding/ModalityDataHelper.psm1' -Recurse
        
        if ($results) {
          $results | Format-Table -AutoSize
          Write-Host "`n‚ùå PSScriptAnalyzer found $($results.Count) issue(s)" -ForegroundColor Red
          exit 1
        } else {
          Write-Host "`n‚úÖ PSScriptAnalyzer: No issues found" -ForegroundColor Green
        }

<#
.NOTES
    Checkpoint MOD-003: CI/CD pipeline created
    Status: Hour 1 deliverable
    Triggers: push/PR to main/develop, workflow_dispatch
    Jobs: test (Pester 5.5.0+, JaCoCo coverage, NUnit results), lint (PSScriptAnalyzer)
    Next: Hour 2 - Activate pipeline on first push with Voice stream implementation
#>
