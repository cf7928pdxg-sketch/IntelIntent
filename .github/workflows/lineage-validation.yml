name: âš›ï¸ Lineage Validation

on:
  push:
    branches: [main]
    paths:
      - 'LINEAGE_AFFIRMATION.json'
  pull_request:
    branches: [main]
    paths:
      - 'LINEAGE_AFFIRMATION.json'
  workflow_dispatch:

jobs:
  validate-lineage:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ›ï¸ Checkout Temple
        uses: actions/checkout@v4
      
      - name: ðŸ“œ Validate JSON Schema
        run: |
          echo "ðŸ” Validating LINEAGE_AFFIRMATION.json structure..."
          
          if jq empty LINEAGE_AFFIRMATION.json 2>/dev/null; then
            echo "âœ… JSON structure valid"
          else
            echo "âŒ JSON structure invalid"
            exit 1
          fi
      
      - name: ðŸ” Verify DID Format
        run: |
          echo "ðŸ” Checking Decentralized Identifier (DID) format..."
          
          jq -r '.lineages[].sovereign_identity.did' LINEAGE_AFFIRMATION.json | while read did; do
            if [[ "$did" =~ ^did:[a-z]+:[a-zA-Z0-9._:-]+$ ]]; then
              echo "âœ… Valid DID: $did"
            else
              echo "âŒ Invalid DID format: $did"
              exit 1
            fi
          done
      
      - name: ðŸ”¥ðŸ¦… Verify Phoenix Convergence
        run: |
          echo "ðŸ” Checking Phoenix symbol in convergence..."
          
          phoenix=$(jq -r '.convergence.phoenix_symbol' LINEAGE_AFFIRMATION.json)
          
          if [[ "$phoenix" == "ðŸ”¥ðŸ¦…" ]]; then
            echo "âœ… Phoenix convergence verified: $phoenix"
          else
            echo "âŒ Phoenix symbol missing or incorrect: $phoenix"
            exit 1
          fi
      
      - name: ðŸ“Š Count Lineage Ancestors
        run: |
          count=$(jq '.lineages | length' LINEAGE_AFFIRMATION.json)
          echo "âœ… Lineage count: $count ancestors"
          
          if [[ $count -ge 6 ]]; then
            echo "ðŸŽ‰ All 6+ ancestors affirmed"
          else
            echo "âš ï¸ Expected 6+ ancestors, found $count"
          fi
      
      - name: ðŸŽ¨ Validate Color Resonance
        run: |
          echo "ðŸ” Checking color resonance palettes..."
          
          jq -r '.lineages[] | "\(.name): \(.color_resonance.primary) + \(.color_resonance.secondary)"' LINEAGE_AFFIRMATION.json | while read line; do
            echo "âœ… $line"
          done
      
      - name: ðŸ” Check Signature Placeholders
        run: |
          echo "ðŸ” Verifying Ed25519 signature structure..."
          
          signatures=$(jq -r '.lineages[].sovereign_identity.signature' LINEAGE_AFFIRMATION.json | grep -c "ed25519:")
          
          if [[ $signatures -ge 6 ]]; then
            echo "âœ… All lineages have signature placeholders"
            echo "âš ï¸ Note: Signatures are placeholders - replace with real Ed25519 signatures"
          else
            echo "âŒ Missing signature placeholders"
            exit 1
          fi
      
      - name: ðŸ“ Generate Validation Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const lineage = JSON.parse(fs.readFileSync('LINEAGE_AFFIRMATION.json', 'utf8'));
            
            const report = `## âš›ï¸ Lineage Validation Report
            
            **Status**: âœ… All checks passed
            
            ### Validated Ancestors
            ${lineage.lineages.map(l => 
              `- ${l.ceremonial_glyph} **${l.name}** (${l.timeline.start}-${l.timeline.end})`
            ).join('\n')}
            
            ### Phoenix Convergence
            **Symbol**: ${lineage.convergence.phoenix_symbol}  
            **Geometry**: ${lineage.convergence.vesica_piscis.description}
            
            ### Cryptographic Provenance
            - **Algorithm**: ${lineage.provenance.signature_algorithm}
            - **Hash Algorithm**: ${lineage.provenance.hash_algorithm}
            - **Blockchain**: ${lineage.provenance.blockchain_commitment.chain}
            
            ### Ceremonial Seal
            > "${lineage.provenance.ceremonial_seal}"
            
            ---
            *Lineage Keepers*: ${lineage.metadata.lineage_keepers.map(k => k.name).join(', ')}  
            *Validation Date*: ${new Date().toISOString()}
            `;
            
            await core.summary.addRaw(report).write();
            console.log('âœ… Lineage validation report generated');
