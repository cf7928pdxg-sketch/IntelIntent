
name: publish-kb

on:
  workflow_dispatch:
    inputs:
      siteUrl:
        description: 'SharePoint site URL (e.g., https://contoso.sharepoint.com/sites/umms-ngmi)'
        required: true
      siteName:
        description: 'SharePoint site name (used if provisioning is needed)'
        required: true
      branch:
        description: 'Docs branch/ref to publish'
        required: false
        default: 'main'

permissions:
  id-token: write
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CLI for Microsoft 365 + MD tools
        run: |
          npm i -g @pnp/cli-microsoft365@latest markdown-it@14 markdown-it-front-matter@0

      - name: Login to Microsoft 365 (certificate)
        env:
          M365_TENANT: ${{ secrets.M365_TENANT }}
          M365_APP_ID: ${{ secrets.M365_APP_ID }}
          M365_CERT_B64: ${{ secrets.M365_CERT_B64 }}
          M365_CERT_PASSPHRASE: ${{ secrets.M365_CERT_PASSPHRASE }}
        run: |
          m365 login --authType certificate \
            --tenant $M365_TENANT \
            --appId $M365_APP_ID \
            --certificateBase64Encoded "$M365_CERT_B64" \
            --password "$M365_CERT_PASSPHRASE"

      - name: Ensure Communication Site exists
        run: |
          m365 spo site add --type CommunicationSite \
            --url "${{ github.event.inputs.siteUrl }}" \
            --title "${{ github.event.inputs.siteName }}" \
            --siteDesign Topic || echo "Site already exists or cannot be created by app."

      - name: Ensure libraries & columns
        run: |
          m365 spo list add --title Docs --url "${{ github.event.inputs.siteUrl }}" --listTemplate DocumentLibrary || true
          m365 spo field add --webUrl "${{ github.event.inputs.siteUrl }}" --listTitle Docs --xml '<Field DisplayName="Domain" Name="Domain" Type="Choice"><CHOICES><CHOICE>personal</CHOICE><CHOICE>family</CHOICE><CHOICE>business</CHOICE><CHOICE>shared-platform</CHOICE></CHOICES></Field>' || true
          m365 spo field add --webUrl "${{ github.event.inputs.siteUrl }}" --listTitle Docs --xml '<Field DisplayName="Portfolio" Name="Portfolio" Type="Text" />' || true
          m365 spo field add --webUrl "${{ github.event.inputs.siteUrl }}" --listTitle Docs --xml '<Field DisplayName="Module" Name="Module" Type="Text" />' || true
          m365 spo field add --webUrl "${{ github.event.inputs.siteUrl }}" --listTitle Docs --xml '<Field DisplayName="Status" Name="Status" Type="Choice"><CHOICES><CHOICE>Draft</CHOICE><CHOICE>In Review</CHOICE><CHOICE>Published</CHOICE></CHOICES></Field>' || true

      - name: Convert Markdown and upload with metadata
        shell: bash
        run: |
          set -e
          FILES=$(git ls-files | grep -E '^docs/.*\.md$' || true)
          for f in $FILES; do
            htmlfile=$(echo $f | sed 's/.md$/.html/')
            node -e "const fs=require('fs');const md=require('markdown-it')();const fm=require('markdown-it-front-matter');let fmdata={};md.use(fm, fm=>{fmdata=fm});const src=fs.readFileSync('$f','utf8');const out=md.render(src);fs.mkdirSync(require('path').dirname('$htmlfile'),{recursive:true});fs.writeFileSync('$htmlfile',out);"
            portfolio=$(echo $f | awk -F'/' '{print $2}' | sed 's/^[0-9][0-9]-//')
            domain=$(echo $f | grep -oE '/(personal|family|business|shared-platform)/' | sed 's#/##g' | head -n1)
            module=$(basename "$f" .md)
            m365 spo file add --filePath "$f" --webUrl "${{ github.event.inputs.siteUrl }}" --folder "Shared Documents/Docs" --overwrite || true
            m365 spo file set --webUrl "${{ github.event.inputs.siteUrl }}" --fileUrl "Shared Documents/Docs/$(basename $f)" --properties "Domain=$domain,Portfolio=$portfolio,Module=$module,Status=Published" || true
          done

      - name: Create/Update Site Pages from HTML
        shell: bash
        run: |
          HTMLS=$(git ls-files | grep -E '^docs/.*\.html$' || true)
          for h in $HTMLS; do
            page=$(basename "$h" .html).aspx
            m365 spo page add --name "$page" --webUrl "${{ github.event.inputs.siteUrl }}" --publish || true
            m365 spo page text add --pageName "$page" --webUrl "${{ github.event.inputs.siteUrl }}" --text "$(cat $h | sed 's/"/\\"/g')" --section 1 --column 1 || true
          done

      - name: Ensure Home.aspx
        run: |
          m365 spo page add --name Home.aspx --webUrl "${{ github.event.inputs.siteUrl }}" --publish || true
          m365 spo page text add --pageName Home.aspx --webUrl "${{ github.event.inputs.siteUrl }}" --text "<h1>Unified Microsoft Modernization System â€” KB</h1><p>Published on ${{ github.run_id }}</p>" --section 1 --column 1 || true
